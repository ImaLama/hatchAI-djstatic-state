---
# ==== TaskSpec METADATA (edit only the right-hand values) =====
id: 004-TS-2025-08-19-AGENT-STATE-HUB-CORE
title: Implement central state hub coordinator            # "Add sharded event dir"
created: 2025-08-19-13-46                   # creation datetime
updated: 2025-08-19-13-46                   # last update datetime
sprint: S4                                  # S4, S5, …
parent_featspec: 002-FS-2025-08-19-AGENT-STATE-HUB  # Required parent feature
type: feature                               # fix|feature|test|refactor|docs|integration
loc_cap: 200                                # net LoC (adds-deletes) - auto-set by type
coverage_cap: 80                            # % required by testing
depends_on: []                              # ["NNN-TS-...", ...]
# =============================================================
---

## 1  Context
Enhances existing agent_state_manager.sh to serve as the central state hub coordinator. Part of Agent State Hub (002-FS-2025-08-19-AGENT-STATE-HUB). Builds on current JSON state management with improved conflict resolution, atomic updates, and source tracking.

## 2  Objectives (acceptance criteria) - TDD WORKFLOW
List **observable, testable** outcomes. Use MUST/SHOULD/MUST NOT keywords.

| # | Acceptance Test | Type | File/Command | Execution Evidence Required |
|---|-----------------|------|--------------|----------------------------|
| 1 | MUST handle concurrent updates with file locking | unit | test_concurrent_locks.sh | Show no race conditions |
| 2 | MUST perform atomic JSON updates (all-or-nothing) | unit | test_atomic_updates.sh | Show transaction behavior |
| 3 | MUST track update source in metadata | unit | test_source_tracking.sh | Show source attribution |
| 4 | MUST resolve conflicts with last-write-wins + logging | unit | test_conflict_resolution.sh | Show conflict logs |
| 5 | MUST maintain backward compatibility with existing calls | integration | test_backward_compat.sh | Show old calls work |
| 6 | MUST complete updates in < 50ms under normal load | perf | test_performance.sh | Show timing metrics |

## 3  Non-Goals / Anti-Goals
• Will NOT implement trigger files (removed in cleanup)
• Will NOT use database or external storage
• Will NOT implement complex conflict resolution strategies
• Will NOT modify existing hook interfaces

## 4  Design Constraints
• Enhance existing agent_state_manager.sh (don't replace)
• Use flock for file locking (already working)
• Keep changes minimal and backward compatible
• JSON remains the only storage format
• Must integrate cleanly with parent FeatSpec: 002-FS-2025-08-19-AGENT-STATE-HUB

## 5  Implementation Checklist (TDD Factory Workflow)
- [ ] **RED**: Write test for concurrent file locking
- [ ] **GREEN**: Verify existing flock implementation works
- [ ] **REFACTOR**: Improve lock timeout handling
- [ ] **RED**: Write test for atomic updates
- [ ] **GREEN**: Implement temp file + rename pattern
- [ ] **REFACTOR**: Add rollback on failure
- [ ] **RED**: Write test for source tracking
- [ ] **GREEN**: Add "updated_by" field to JSON
- [ ] **REFACTOR**: Structure metadata properly
- [ ] **RED**: Write test for backward compatibility
- [ ] **GREEN**: Ensure old calling patterns work
- [ ] **REFACTOR**: Clean up parameter handling
- [ ] Update parent FeatSpec state tracking
- [ ] Commit with trailer `TaskSpec: 004-TS-2025-08-19-AGENT-STATE-HUB-CORE status=qa`

## 6  QA Checklist
- [ ] Review test coverage & LoC cap
- [ ] Compare code vs Architecture-Implementation Alignment Matrix
- [ ] Verify integration with parent FeatSpec
- [ ] If pass, commit trailer `TaskSpec: {{id}} status=done`

## 7  Post-Merge Tasks
Update parent FeatSpec state, close related issues.